# Implementation Plan: [FEATURE]

**Branch**: `[###-feature-name]` | **Date**: [DATE] | **Spec**: [link]
**Input**: Feature specification from `/specs/[###-feature-name]/spec.md`

**Note**: This template is filled in by the `/sp.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Implement a persistent AI chatbot interface using react-chat-widget (as the OpenAI ChatKit React SDK does not exist) that integrates with our existing Better Auth authentication system and FastAPI backend. The GlobalChatWidget component will be mounted at the root layout level to maintain persistent state across navigation, with a custom fetch implementation that injects JWT tokens into all requests to our /api/chat endpoint. This will enable users to access the AI assistant from any page via a floating action button and perform task management operations with immediate UI updates upon successful operations.

## Technical Context

**Language/Version**: TypeScript 5.7+, React 19, Next.js 16.0.3, Python 3.11+
**Primary Dependencies**: Next.js, React, Better Auth, react-chat-widget, FastAPI, SQLModel
**Storage**: Neon PostgreSQL database accessed via SQLModel ORM
**Testing**: Jest for frontend, pytest for backend
**Target Platform**: Web application (Next.js App Router) with FastAPI backend
**Project Type**: Web application (frontend + backend)
**Performance Goals**: <500ms response time for chat interactions, persistent chat widget state across navigation
**Constraints**: Must use JWT authentication via Better Auth, must communicate with local FastAPI endpoint at /api/chat, must maintain persistent state across navigation
**Scale/Scope**: Individual user chat sessions with AI assistant for task management

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

1. **No Task = No Code**: All implementation work must be traced back to specific tasks in the tasks.md file generated by /sp.tasks
2. **Technology Stack Evolution**: Implementation uses Next.js 16, React 19 as required in the tech stack evolution
3. **JWT-based Authentication**: Implementation uses Better Auth for JWT-based authentication as required
4. **AI Chatbot Interface**: Implementation satisfies the mandatory AI chatbot interface requirement using appropriate libraries
5. **Security Compliance**: Authentication tokens are properly injected into all requests ensuring secure communication
6. **State Management**: The persistent chat widget maintains state across navigation as required by the feature spec

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command)
├── data-model.md        # Phase 1 output (/sp.plan command)
├── quickstart.md        # Phase 1 output (/sp.plan command)
├── contracts/           # Phase 1 output (/sp.plan command)
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/
│   ├── services/
│   └── api/
├── routes/
│   └── chat.py              # New endpoint for /api/chat
└── tests/

frontend/
├── components/
│   └── ai/
│       └── GlobalChatWidget.tsx    # New persistent chat widget
├── lib/
│   ├── auth-client.ts       # Better Auth client
│   └── api-client.ts        # API client with auth integration
├── app/
│   └── layout.tsx           # Modified to include GlobalChatWidget
└── tests/
```

**Structure Decision**: This is a web application with frontend and backend components. The frontend implements the persistent chat widget component and integrates it at the root layout level. The backend provides the /api/chat endpoint for AI communication with proper authentication middleware.

## Phase 0: Configuration Strategy

### NEXT_PUBLIC_API_URL Environment Variable Integration

The GlobalChatWidget component will use the NEXT_PUBLIC_API_URL environment variable to determine the backend endpoint for chat requests. This approach provides flexibility across different deployment environments (development, staging, production).

**Implementation Details:**
- The component will reference `process.env.NEXT_PUBLIC_API_URL` to construct the API endpoint
- Default fallback value will be provided for local development
- The endpoint will be configured as `${process.env.NEXT_PUBLIC_API_URL}/api/chat`
- Error handling will be implemented for missing or malformed environment variables

### Custom Fetcher Function

A custom fetcher function will be implemented within the GlobalChatWidget component to:
1. Retrieve the active session token using Better Auth's `authClient.getSession()`
2. Attach the Authorization header with `Bearer <token>` format
3. Forward the authenticated request to the configured endpoint
4. Handle authentication failures gracefully

**Implementation Details:**
- Function signature: `authenticatedFetch(url: string, options: RequestInit)`
- Will integrate with existing `authClient.token()` method from the auth-client.ts
- Will handle token refresh if needed
- Will implement proper error handling for authentication failures

## Phase 1: Component Architecture Design

### GlobalChatWidget Component Structure

The component will be designed as a persistent chat widget that:
1. Maintains conversation context across page navigations
2. Integrates seamlessly with the existing UI design system
3. Provides a floating action button for easy access
4. Implements proper authentication flow

**Component Requirements:**
- Built with TypeScript and React 19
- Uses react-chat-widget or similar library for UI components
- Implements client-side session management
- Provides loading states and error handling
- Supports optimistic UI updates after successful task operations

### Authentication Bridge Design

The authentication bridge will ensure secure communication between the chat widget and the backend:

1. **JWT Token Retrieval**: Uses the existing `authClient.token()` method from `lib/auth-client.ts` to retrieve the active JWT token
2. **Header Injection**: Attaches `Authorization: Bearer <token>` to all outgoing requests to the backend
3. **Token Validation**: Validates token existence before making requests and handles missing token scenarios
4. **Error Handling**: Manages authentication failures and triggers appropriate user notifications
5. **Session Management**: Leverages the existing Better Auth session management for token refresh

**Implementation Details:**
- Function will be implemented as `async authenticatedFetch(url: string, options: RequestInit)` within the GlobalChatWidget component
- Will call `const { data, error } = await authClient.token()` to retrieve JWT
- Will inject the token into request headers: `{ ...headers, 'Authorization': 'Bearer ${data.token}' }`
- Will handle 401 responses by triggering a re-authentication flow
- Will provide user feedback when authentication issues occur

## Phase 2: Layout Integration

The GlobalChatWidget will be integrated into the root layout to ensure persistence across navigation:

- **Root Level Integration**: Component will be added to `frontend/app/layout.tsx` after the main content to ensure it appears on all pages
- **Non-Intrusive Positioning**: Widget will be positioned using CSS to not interfere with main content, typically as a floating element in the bottom-right corner
- **Responsive Design**: Component will adapt to different screen sizes, potentially transforming to a minimized state on mobile devices
- **State Persistence**: Using React state management to maintain conversation context between route changes
- **Import Strategy**: The component will be imported with dynamic import to prevent blocking the main rendering thread if needed

**Implementation Details:**
- Import the component in `app/layout.tsx`: `import GlobalChatWidget from '@/components/ai/GlobalChatWidget'`
- Add the component to the layout JSX after the main content: `{children} <GlobalChatWidget />`
- Ensure the component is wrapped properly with any required providers (ThemeProvider, etc.)
- Consider using Next.js dynamic imports with `ssr: false` if the widget shouldn't render on the server
- Position the widget using Tailwind CSS classes to maintain design consistency

## Phase 3: Security and Deployment Considerations

### CORS and Domain Configuration

Since we're using a standard React chat widget rather than OpenAI's ChatKit (which doesn't exist), we need to consider:

1. **Backend API Endpoint Configuration**: Ensure the `/api/chat` endpoint is properly configured to handle requests from the frontend
2. **CORS Policy**: Configure appropriate CORS settings in the FastAPI backend to allow requests from the frontend domain
3. **Environment-Specific URLs**: Properly configure NEXT_PUBLIC_API_URL for different deployment environments (localhost:3000 for development, Vercel URL for production)

**Implementation Details:**
- Update CORS middleware in FastAPI to include frontend domains
- Ensure the backend endpoint accepts requests with proper authorization headers
- Test cross-origin requests in development and production environments

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
